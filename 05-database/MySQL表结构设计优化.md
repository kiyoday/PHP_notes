## 数据库结构优化的目的

- 减少数据冗余
- 尽量避免数据维护中出现更新，插入和删除异常
  - 插入异常:如果表中的某个实体随着另一个实体而存在
  - 更新异常:如果更改表中的某个实体的单独属性时，需要对多行进行更新
  - 删除异常:如果删除表中的某一实体则会导致其他实体的消失

- 节约数据存储空间
- 提高查询效率

## 数据库结构设计的步骤

- 需求分析:
  - 全面了解产品设计的存储需求
  - 存储需求
  - 数据处理需求
  - 数据的安全性和完整性

- 逻辑设计:设计数据的逻辑存储结构
  - 数据实体之间的逻辑关系，
  - 解决数据冗余和数据维护异常

- 物理设计:跟据所使用的数据库特点进行表结构设计
  - 关系型数据库:Oralce，SQLServer，MysqL，postgresSQL
  - 非关系型数据库: mongo，Redis，Hadoop

## 数据库设计范式

- 数据库设计的第一范式
  - 数据库表中的所有字段都只具有单一属性
  - 单一属性的列是由基本的数据类型所构成的

- 数据库设计的第二范式
  - 要求一个表中只具有一个业务`主键`
  - 表中不能存在非主键列对只对部分主键的`依赖`关系

- 数据库设计的第三范式

  - 指每一个非主属性既不部分依赖于也不传递依赖于业务主键，

  - 也就是在第二范式的基础上消除了非主属性对主键的传递依赖

## 实战

按下面的需求设计一个电子商务网站的数据库结构

1. 本网站只销售图书类商品
2. 需要具有以下功能
   用户登陆
   商品展示
   供应商管理
   用户管理
   商品管理
   在线销售

### 用户登陆及用户管理功能

- 用户必须注册并登陆系统才能进行网上交易

- 用户名来作为用户信息的业务主键

- 同一时间一个用户只能在一个地方登陆

- 用户信息: {用户名，密码，手机号，姓名，注册日期，在线状态，出生日期}

  - 只有一个业务主键，一定是符合第二范式

  - 没有属性和业务主键存在传递依赖的关系，符合第三范式

### 商品展示及商品管理功能

- 商品信息: {商品名称，分类名称，出版社名称，图书价格，图书描述，作者}
  - 商品信息: {商品名称，出版社名称，图书价格，图书描述，作者}
  - 分类信息: {分类名称，分类描述}
  - 商品分类(对应关系表) : {商品名称，分类名称}

### 在线销售功能

1. 只有一个业务主键，符合第二范式
2. 订单商品单价，订单商品数量，订单编号存在着传递依赖关系，不符合第三范式
3. 数据冗余→订单商品信息和商品信信息表中的数据

- 在线销售: {订单编号，下单用户名，下单日期，订单金额，订单商品分类，订单商品名，订单商品单价，订单商品数量，支付金额，物流单号}
  - 订单表: {订单编号，下单用户名，下单日期，支付金额，物流单号}
  - 订单商品关联表: {订单编号，订单商品分类，订单商品名，商品数量}

<img src="C:\Users\12605\Desktop\PHP_notes\.img\image-20200706192823774.png" alt="image-20200706192823774" style="zoom:80%;" />



假设下单用户就是商品的收货人，我们在发货前定要查询出每个订单的下单人的信息，而这些信息全部记录在用户信息表中

<img src="C:\Users\12605\Desktop\PHP_notes\.img\image-20200706192926994.png" alt="image-20200706192926994" style="zoom:80%;" />

## 反范式化设计

### 什么叫做反范式化设计

反范式化是针对范式化而言的， 在前面介绍了数据库设计的范式，所谓的反范式化就是为了性能和读取效率的考虑
而适当的对数据库设计范式的要求进行违反，而`允许存在少量的数据冗余`，换句话来说反范式化就是使用`空间来换取时间`

### 图书在线销售网站数据库的反范式化改造

![image-20200706194129696](C:\Users\12605\Desktop\PHP_notes\.img\image-20200706194129696.png)

### 图书在线销售网站数据库的反范式化改造

![image-20200706194258649](C:\Users\12605\Desktop\PHP_notes\.img\image-20200706194258649.png)

### 反范式化改造后的查询

<img src="C:\Users\12605\Desktop\PHP_notes\.img\image-20200706194324770.png" alt="image-20200706194324770" style="zoom:80%;" />

<img src="C:\Users\12605\Desktop\PHP_notes\.img\image-20200706194351712.png" alt="image-20200706194351712" style="zoom: 80%;" />

## 对比范式与反范式

|          | 范式化设计                                                   | 反范式化设计                                              |
| -------- | ------------------------------------------------------------ | --------------------------------------------------------- |
| **优点** | 可以尽量的减少数据冗余<br/>数据表更新快体积小<br/>范式化的更新操作比反范式化更快<br/>范式化的表通常比反范式化更小 | 可以减少表的关联<br/>可以更好的进行索引优化               |
| **缺点** | 对于查询需要对多个表进行关联<br />更难进行索引优化           | 存在数据冗余及数据维护异常<br/>对数据的修改需要更多的成本 |

一般会结合两种进行设计

## 物理设计

### 物理设计涉及的内容

- 定义数据库、表及字段的命名规范
- 选择合适的存储引擎
- 为表中的字段选择合适的数据类型
- 建立数据库结构

### 定义数据库、表及字段的命名规范

可读性原则
表意性原则
长名原则

### 选择合适的存储引擎

![image-20200706195822443](C:\Users\12605\Desktop\PHP_notes\.img\image-20200706195822443.png)

## 数据类型

当一个列可以选择多种数据类型时，

应该优先考虑`数字`类型，其次是`日期`或`二进制`类型，最后是`字符`类型。

对于相同级别的数据类型，应该优先选择`占用空间小`的数据类型

### 整数类型

![image-20200706200415613](C:\Users\12605\Desktop\PHP_notes\.img\image-20200706200415613.png)

### 实数类型

![image-20200706200549431](C:\Users\12605\Desktop\PHP_notes\.img\image-20200706200549431.png)

`DECIMAL(18，9)`需要9个字节来存储

### VARCHAR和CHAR类型 

> 占用单位为`字符`而不是`字节`，也就是长度

#### `VARCHAR类型`的存储特点

- varchar用于存储变长字符串，只占用必要的存储空间
- 列的最大长度`小于255`则只占用`一个`额外字节用于记录字符串长度
- 列的最大长度`大于255`则要占用`两个`额外字节用于记录字符串长度

#### - VARCHAR长度的选择问题

- 使用最小的符合需求的长度
- varchar(5)和varchar(200)存储'MySQL'字符串`性能不同`

#### VARCHAR的适用场景

- 字符串列的`最大长度比平均长度大`很多
- 字符串列`很少被更新`
- 使用了`多字节字符集`存储字符串

#### `CHAR类型`的存储特点

- CHAR类型是`定长`的
- 字符串存储在CHAR类型的列中会`删除末尾的空格`
- CHAR类型的`最大宽度为255`

### CHAR类型的适用场景

- CHAR类型适合存储所长度近似的值 如`手机号`，`md5`
- CHAR类型适合存储`短字符串`
- CHAR类型适合存储`经常更新`的字符串列

## 如何存储日期数据

### DATATIME类型

- 以`YYYY-MM-DD HH:MM:SS[.fraction]`格式存储日期时间
  datetime = YYYY-MM-DD HH:MM:SS
  datetime(6) = YYYY-MM-DD HH:MM:SS.fraction

- DATATIME类型`与时区无关`，占用`8`个字节的存储空间

- 时间范围1000-01-01 00:00:00到9999-12-31 23:59:59

### TIMESTAMP类型

- timestamp类型显示`依赖于所指定的时区`

- 在行的数据修改时可以`自动更新第一个timestamp列的值`

  `set time_zone= '-10:00'`

### 5.7之后时间存储的选择date类型和time类型

一是把日期部分存储为字符串 (至少要8个字)
二是使用int类型来存储( 4个字节)
三是使用datetime类型来存储( 8个字节)

### date类型和time类型

#### date类型的优点:

1.`占用的字节数`比使用字符串、datetime、 int存储要少，使用date类型只需要`3`个字节
2.使用Date类型还可以利用日期时间函数进行日期之间的`计算`

date类型用于保存1000-01-01到9999-12-31之间的`日期`
time类型用于存储`时间数据`，格式为HH:MM:SS

#### 存储日期时间数据的注意事项

- 不要使用字符串类型来存储日期时间数据
  - 日期时间类型通常比字符串占用的`存储空间小`
  - 日期时间类型在进行`查找过滤`时可以利用日期来进行对比
  - 日期时间类型还有着丰富的`处理函数`，可以方便的对时期类型进行日期计算

- 使用Int存储日期时间不如使用Timestamp类型

## 总结

<img src="C:\Users\12605\Desktop\PHP_notes\.img\image-20200706210555222.png" alt="image-20200706210555222" style="zoom: 80%;" />

