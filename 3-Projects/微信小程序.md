# 框架构思

## 整体框架：

1. 服务端:
   Thinkphp 5 + MySQL构建REST API

2. 客户端:
   向服务端请求数据,完成自身行为逻辑

3. CMS :
向服务端请求数据,实现发货与发送微信消息

## CMS功能总结

两大类
1.基础数据的增删改查,比如添加商品,删除商品类目
2.特殊操作,比如我们要实现的发送微信消息

## 项目特点

我们想构建一个通用的、适合互联网公司的、有良好结构的产品
三端分离(客户端、服务器与数据管理分离)
基于REST API
基于Token令牌管理权限
比cookie实现登录更好用，通用性更高
-套架构适配iOS、Android. 小程序与单页面
真正理解MVC
AOP面向切面编程思想在真实项目中的应用
使用ORM的方式与数据库交互
Object Relational Mapping
MySQL数据表设计与数据冗余的合理利用
用面向对象的思维构建前端代码( ES6 Class&Module )

## 技术

@ ThinkPHP 5
●Web框架3三大核心知识(路由、控制器与模型)
●验证器、读取器、缓存与全局异常处理
●ORM: 模型与关联模型
主流框架部支持
@微信
●微信小程序
●微信登录
●微信支付(预订单、支付与回调通知处理)
●微信模板消息
@ MySQL
●数据库表设计
●数据冗余的合理利用
●事务与锁在订单(库存量)检测中的应用

# 环境与工具

### Web框架

●ThinkPHP 5.07

### 基础语言、环境

●PHP 5.6
●MySQL
●Apache

### 开发工具

PHPStorm
微信Web开发者工具 ( VS Code )
PostMan
Navicat
ThinkPHP 只是Web框架
还需要PHP运行环境
和Web服务器
常见Web服务器 : Apache、Nginx

## xampp配置

xampp只勾选`Apache、mysql`

- windows查看占用端口

  ```php
  netstat -ano
  ```

  

- 在目录下查看mysql和PHP运行是否成功

  ```bash
mysql -uroot -P
  
  php -V
  ```
  
  

### **配置虚拟域名简化URL路径**

apache\conf\extra\httpd-vhosts.conf

![image-20200629180409294](C:\Users\12605\Desktop\PHP_notes\.img\image-20200629180409294.png)

### 配置host文件

运行：C:\Windows\System32\drivers\etc

追加：127.0.0.1 s.cn

## TP框架

###  入口文件路径

`public/index.php`

### TP框架目录

```
project  应用部署目录
├─application           应用目录（可设置）
│  ├─common             公共模块目录（可更改）
│  ├─index              模块目录(可更改)
│  │  ├─config.php      模块配置文件
│  │  ├─common.php      模块函数文件
│  │  ├─controller      控制器目录
│  │  ├─model           模型目录
│  │  ├─view            视图目录
│  │  └─ ...            更多类库目录
│  ├─command.php        命令行工具配置文件
│  ├─common.php         应用公共（函数）文件
│  ├─config.php         应用（公共）配置文件
│  ├─database.php       数据库配置文件
│  ├─tags.php           应用行为扩展定义文件
│  └─route.php          路由配置文件
├─extend                扩展类库目录（可定义）
├─public                WEB 部署目录（对外访问目录）
│  ├─static             静态资源存放目录(css,js,image)
│  ├─index.php          应用入口文件
│  ├─router.php         快速测试文件
│  └─.htaccess          用于 apache 的重写
├─runtime               应用的运行时目录（可写，可设置）
├─vendor                第三方类库目录（Composer）
├─thinkphp              框架系统目录
│  ├─lang               语言包目录
│  ├─library            框架核心类库目录
│  │  ├─think           Think 类库包目录
│  │  └─traits          系统 Traits 目录
│  ├─tpl                系统模板目录
│  ├─.htaccess          用于 apache 的重写
│  ├─.travis.yml        CI 定义文件
│  ├─base.php           基础定义文件
│  ├─composer.json      composer 定义文件
│  ├─console.php        控制台入口文件
│  ├─convention.php     惯例配置文件
│  ├─helper.php         助手函数文件（可选）
│  ├─LICENSE.txt        授权说明文件
│  ├─phpunit.xml        单元测试配置文件
│  ├─README.md          README 文件
│  └─start.php          框架引导文件
├─build.php             自动生成定义文件（参考）
├─composer.json         composer 定义文件
├─LICENSE.txt           授权说明文件
├─README.md             README 文件
├─think                 命令行入口文件
```

> router.php用于php自带`webserver`支持，可用于快速测试
> 启动命令：`php -S localhost:8888 router.php`

## phpstorm自动补全命名空间

setting →Directories→Sources

![image-20200629180912310](C:\Users\12605\Desktop\PHP_notes\.img\image-20200629180912310.png)

# 路由

## 路由文件\定义路由

`application\route.php`

### 3种url路径格式

- #### PATH_INFO（关闭路由，默认）

  关闭路由，完全使用默认的`PATH_INFO`方式URL：

  ```php
  'url_route_on'  =>  false,
  ```

  路由关闭后，不会解析任何路由规则，采用默认的`PATH_INFO` 模式访问URL：

  ```
  http://serverName/index.php/module/controller/action/param/value/...
  ```

  > 但仍然可以通过操作方法的参数绑定、空控制器和空操作等特性实现URL地址的简化。

- #### 混合模式

  开启路由，并使用路由定义+默认`PATH_INFO`方式的混合：

  ```php
  'url_route_on'  =>  true,
  'url_route_must'=>  false,
  ```

  该方式下面，只需要对需要定义路由规则的访问地址定义路由规则，其它的仍然按照第一种普通模式的`PATH_INFO`模式访问URL。

- #### 强制使用路由模式

  `application\config.php`

  ```php
  // 路由配置文件（支持配置多个）
  'route_config_file'      => ['route'],
  // 是否强制使用路由
  'url_route_must'         => true,
  'url_route_on'  		=>  true,
  ```

  这种方式下面必须严格给每一个访问地址定义路由规则（包括首页），否则将抛出异常。

  首页的路由规则采用`/`定义即可，例如下面把网站首页路由输出`Hello,world!`

  ```php
  Route::get('/',function(){
      return 'Hello,world!';
  });
  ```

### 定义路由

如果要定义get和post请求支持的路由规则，也可以用：

```php
Route::rule('new/:id','News/read','GET|POST');
```

## 路由直接获取参数

### 方法1：路由给

​	s.cn/hello?name= kiyo&id=1997

使用`：`跟一个参数

```php
Route::post('hello/:id','sample/Test/hello');
```

### 方法2：request



# 微信登陆与Token令牌

## 1、初识Token-意义与作用

### 通用令牌体系

- 获取令牌

![image-20200628173715889](C:\Users\12605\Desktop\PHP_notes\.img\image-20200628173715889.png)

- 验证token 

  是否合法

  是否过期

  是否拥有访问接口的权限

![image-20200628173743003](C:\Users\12605\Desktop\PHP_notes\.img\image-20200628173743003.png)

### 微信的token体系

生成并获取token

![image-20200628173835444](C:\Users\12605\Desktop\PHP_notes\.img\image-20200628173835444.png)

校验

每次小程序请求会从redis缓存中获取token并验证权限等

![image-20200628180138764](C:\Users\12605\Desktop\PHP_notes\.img\image-20200628180138764.png)





## 2、实现TOKEN身份权限体系

### 获取Token令牌

```php
namespace app\api\controller\V1;

class Token
{
    public function getToken($code=''){
        (new TokenGet())->goCheck();
        $ut = new UserToken($code);
        $token = $ut->get();
        return [//返回json格式
            'token'=>$token
        ];

```



## 3、路由变量规则与分组

## 4、闭包函数构建查询器

## 5、用户收货地址

**前面都是查询接口** 现在是create接口特定用户才能调用接口（接口保护）![image-20200629085905382](C:\Users\12605\Desktop\PHP_notes\.img\image-20200629085905382.png)

# 微信支付、下单

## Scope权限作用域的应用、前置方法

封装用户权限

```php
//准备缓存openid,封装$cacheValue
private function prepareCacheValue($wxResult, $uid){
    $cacheValue = $wxResult;
    $cacheValue['uid'] = $uid;
    $cacheValue['scope'] = ScopeEnum::User;//权限
    return $cacheValue;
}
```

thinkphp的前置方法

```php
class Address extends BaseController
{
    protected $beforeActionList = [
        'checkPrimaryScope' => ['only' => 'createOrUpdateAddress'],
    ];
```

## 下单与支付的业务流程

![image-20200629101107837](C:\Users\12605\Desktop\PHP_notes\.img\image-20200629101107837.png)

**重构权限控制前置方法**

- **封装到service\Token**